<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" href="mobile/css/common.css">
	<link rel="stylesheet" href="mobile/css/applyList.css">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>
	<!-- 모바일 컨테이너 -->
	<div id="mobile-container">
		<!-- 헤더 -->
		<header></header>
		<!-- 컨텐츠 컨테이너 -->
		<div id="container">

			<div th:unless="${#lists.isEmpty(applyList)}">
				<div class="box-container" th:each="a : ${applyList}">
					<div class="nickname-container">
						<div th:text="${a.nickname}"></div>
						<div class="email" th:text="${a.email}"></div>
					</div>
					<div th:text="${a.age}+ '세/'+${a.gender =='M' ? '남':'여'}"></div>
					<div th:text="${a.userTier}">A</div>
					<div class="img-container">
						<img class="approval" src="mobile/img/Checked.svg" data-bs-toggle="modal" data-bs-target="#applyMember"
							th:data-membername="${a.nickname}" th:data-memberid="${a.userId}">
						<img class="refuse" src="mobile/img/Close_red.svg" data-bs-toggle="modal" data-bs-target="#cancelMember"
							th:data-membername="${a.nickname}" th:data-memberid="${a.userId}">
					</div>
				</div>
			</div>
			<div th:if="${#lists.isEmpty(applyList)}" class="d-flex justify-content-center mt-5">
				가입 신청 내역이 없습니다.
			</div>


			<!-- 승인
             모달 -->
			<div class="modal" id="applyMember" tabindex="-1">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content align-items-center">
						<div class="modal-header border-bottom-0 m-2">
							<h1 class="modal-title fs-5" id="teamModalTitle"></h1>
						</div>
						<div class="modal-body">
							<p>가입신청 승인 하시겠습니까?</p>
						</div>
						<div class="modal-footer justify-content-center border-top-0">
							<button type="button" class="btn btn-success" id="okBtn">승인</button>
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>

			<!-- 거절 모달 -->
			<div class="modal" id="cancelMember" tabindex="-1">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content align-items-center">
						<div class="modal-header border-bottom-0 m-2">
							<h1 class="modal-title fs-5" id="teamModalTitle2"></h1>
						</div>
						<div class="modal-body">
							<p>가입신청 거절 하시겠습니까?</p>
						</div>
						<div class="modal-footer justify-content-center border-top-0">
							<button type="button" class="btn btn-success" id="cancelBtn">거절</button>
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>

			<!-- 모집 마감 모달-->
			<div class="modal" id="recruitmentModal" tabindex="-1">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content align-items-center">
						<div class="modal-header border-bottom-0 m-2">
							<h1 class="modal-title fs-5" id="teamModalTitle2"></h1>
						</div>
						<div class="modal-body">
							<p>모집 마감 하시겠습니까?</p>
						</div>
						<div class="modal-footer justify-content-center border-top-0">
							<button type="button" class="btn btn-success" id="recruitmentBtn">확인</button>
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
						</div>
					</div>
				</div>
			</div>

			<div id="createTeamBox">
				<div id="createTeam" class="d-flex justify-content-center">
					<button class="btn rounded-5 p-2 ps-4 pe-4" id="addTeam" data-bs-toggle="modal"
						data-bs-target="#recruitmentModal">모집 마감하기</button>
				</div>
			</div>
		</div>

		<!-- 하단 메뉴바 -->
		<nav></nav>
	</div>

	<script>

		const url = new URL(window.location.href);
		const urlParams = url.searchParams;
		var teamSeq = urlParams.get('teamSeq');

		// header, nav 내용 불러오기
		$(document).ready(function () {
			$('header').load('./common/header_back.html', function () { // 뒤로가기 필요한 페이지는 header_back, 아닌 페이지는 header 사용해주세욤
				$('#page-name').text('신청 리스트'); // 해당 페이지 이름 넣어주세욤 ex) 마이페이지
				$('#user-tier').text('A'); // 나중에 세션에서 usertier 구해서 넣기
			});
			$('nav').load('./common/nav.html');
		});

		window.onload = function () {
			$('#applyMember').on('show.bs.modal', function (event) {
				memberName = $(event.relatedTarget).data('membername');
				memberId = $(event.relatedTarget).data('memberid');
				$('#teamModalTitle').text(memberName);
				okBtnClick(memberId);
			});

			$('#cancelMember').on('show.bs.modal', function (event) {
				memberName = $(event.relatedTarget).data('membername');
				memberId = $(event.relatedTarget).data('memberid');
				$('#teamModalTitle2').text(memberName);
				cancelBtnClick(memberId);
			});

			$("#recruitmentBtn").on('click', function () {
				$.ajax({
					url: "/team/recruitment",
					type: "PUT",
					dataType: "json",
					success: function (data) {
						location.href = "/teamRank";
					},
					error: function () {
						alert("error");
					}
				});

			})
		}

		function okBtnClick(memberId) {
			$("#okBtn").on('click', function () {
				var btn = $(this);
				if (btn.prop('disabled')) return false;
				btn.prop('disabled', true);
				$.ajax({
					url: "/team/addMember/" + memberId + "/" + teamSeq,
					type: "POST",
					dataType: "json",
					success: function (data) {
						res = data.result;
						btn.prop('disabled', false);
						location.reload(true);
					},
					error: function () {
						alert("error");
					}
				});
			})
		}


		function cancelBtnClick(memberId) {
			$("#cancelBtn").off().on('click', function () {
				console.log(memberId);
				$.ajax({
					url: "/team/cancelmember/" + memberId + "/" + teamSeq,
					type: "delete",
					dataType: "json",
					success: function (data) {
						res = data.result;
						console.log(res);
						location.href = "/teamRank";
					},
					error: function () {
						alert("error");
					}
				});
			})
		}

	</script>
</body>

</html>